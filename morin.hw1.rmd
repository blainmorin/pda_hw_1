---
title: "PHP 2550: Assignment 1"
author: "Blain Morin"
date: "September 13, 2018"
output: 
  html_document:
    theme: "flatly"
---

```{r, include=FALSE}

### Load packages
library(knitr)
library(dplyr)
library(readr)
library(sjPlot)
library(kableExtra)
library(tidyr)
library(ggplot2)
library(gmodels)
library(grid)
library(gridExtra)

```


# Problem #1

**First we construct a data set with just the first observation for each individual:**

```{r, message=FALSE, warning=FALSE}

### Read in data
mcalindon = read_csv("McAlindon_Big.csv")

```

```{r}

### Get only the first observation for each id
first.ob = mcalindon %>%
  group_by(ID) %>%
  slice(1) %>%
  ungroup()

```

### a.) Summarize the average pain score for each of the 7 days of the study.

```{r}

### Take the mean of each pain column and put it in the table "ave.pains"
ave.pains = first.ob %>%
  summarise(mean.p1 = mean(pain.1, na.rm = TRUE),
            mean.p2 = mean(pain.2, na.rm = TRUE),
            mean.p3 = mean(pain.3, na.rm = TRUE),
            mean.p4 = mean(pain.4, na.rm = TRUE),
            mean.p5 = mean(pain.5, na.rm = TRUE),
            mean.p6 = mean(pain.6, na.rm = TRUE),
            mean.p7 = mean(pain.7, na.rm = TRUE))

```

**Here are the average pain measurements for each of the seven periods:**

```{r, echo = FALSE}
kable(ave.pains) %>%
  kable_styling() %>% 
  footnote(general = "Means for each period are calculated with NA values removed.")
```

### b.) Regress each pain score on age and use the summary function to create a summary table for each regression. Then use the confint function to find the 95% confidence interval for the regression slopes and produce a table with the estimates, standard errors, p-values and confidence intervals of the 7 slopes and put these in a single table.

```{r, warning = FALSE}

### Regress each pain score on age
painreg1 = lm(pain.1 ~ age, data = first.ob)
painreg2 = lm(pain.2 ~ age, data = first.ob)
painreg3 = lm(pain.3 ~ age, data = first.ob)
painreg4 = lm(pain.4 ~ age, data = first.ob)
painreg5 = lm(pain.5 ~ age, data = first.ob)
painreg6 = lm(pain.6 ~ age, data = first.ob)
painreg7 = lm(pain.7 ~ age, data = first.ob)

```

**Here are estimates, standard errors, p-values and confidence intervals for each of the regressions:**

```{r, message=FALSE, echo=FALSE, warning=FALSE}
sjt.lm(painreg1,
       painreg2,
       painreg3,
       show.se = TRUE,
       show.r2 = FALSE)

sjt.lm(painreg4,
       painreg5,
       painreg6,
       show.se = TRUE,
       show.r2 = FALSE)

sjt.lm(painreg7,
       show.se = TRUE,
       show.r2 = FALSE)
```

### c.) For each individual fit a regression of pain on time. Summarize the slopes and intercepts produced. 

```{r, warning = FALSE, message=FALSE, fig.width=10, fig.height=10}

get.ints = function (p1, p2, p3, p4, p5, p6, p7, d1, d2, d3, d4, d5, d6, d7) {
  
  data.reg = data.frame(pain = c(p1,p2,p3,p4,p5,p6,p7),
                        day = c(d1,d2,d3,d4,d5,d6,d7))
  
  reg = lm(pain ~ day, data = data.reg)
  return(coef(reg)[1])
  
}

get.slopes = function (p1, p2, p3, p4, p5, p6, p7, d1, d2, d3, d4, d5, d6, d7) {
  
  data.reg = data.frame(pain = c(p1,p2,p3,p4,p5,p6,p7),
                        day = c(d1,d2,d3,d4,d5,d6,d7))
  
  reg = lm(pain ~ day, data = data.reg)
  return(coef(reg)[2])
  
}

indy.regs = first.ob %>% group_by(ID) %>%
  mutate(slope = get.slopes(p1 = pain.1,
                            p2 = pain.2,
                            p3 = pain.3,
                            p4 = pain.4,
                            p5 = pain.5,
                            p6 = pain.6,
                            p7 = pain.7,
                            d1 = lastdt1,
                            d2 = lastdt2,
                            d3 = lastdt3,
                            d4 = lastdt4,
                            d5 = lastdt5,
                            d6 = lastdt6,
                            d7 = lastdt7),
         ints = get.ints(p1 = pain.1,
                            p2 = pain.2,
                            p3 = pain.3,
                            p4 = pain.4,
                            p5 = pain.5,
                            p6 = pain.6,
                            p7 = pain.7,
                            d1 = lastdt1,
                            d2 = lastdt2,
                            d3 = lastdt3,
                            d4 = lastdt4,
                            d5 = lastdt5,
                            d6 = lastdt6,
                            d7 = lastdt7))

hist.slopes = indy.regs %>%
  ggplot(aes(x = slope)) + 
  geom_histogram(bins = 20) +
  geom_vline(aes(xintercept=mean(indy.regs$slope, na.rm = TRUE),color="mean"),
             linetype="dashed",
             size=1) +
  xlab("Slope Coefficient") +
  ylab("Count") +
  ggtitle("Histogram of Slope Coefficients") +
  theme_minimal() +
  scale_color_manual( labels = c(paste("Mean = ", round(mean(indy.regs$slope, na.rm = TRUE), digits = 3))), 
                      name = "Legend: ", values = c(mean = "red")) +
  theme(legend.position = "right")

hist.ints = indy.regs %>%
  ggplot(aes(x = ints)) + 
  geom_histogram(bins = 20) +
  geom_vline(aes(xintercept=mean(indy.regs$ints, na.rm = TRUE), color="mean"),
             linetype="dashed",
             size=1) +
  xlab("Intercept Value") +
  ylab("Count") +
  ggtitle("Histogram of Intercepts") +
  theme_minimal() +
  scale_color_manual( labels = c(paste("Mean = ", round(mean(indy.regs$ints, na.rm = TRUE), digits = 3))), 
                      name = "Legend: ", values = c(mean = "red")) +
  theme(legend.position = "right")

grid.arrange(hist.slopes, hist.ints, nrow = 2)

```

### d.) Are the slopes or intercepts related to any of the patient characteristics (age, race, income, treatment, sex,  occupation, working status, use of NSAIDs)?

```{r}

slope.reg = lm(slope ~ as.factor(Race) + age + as.factor(inccat) + bmi + treat + as.factor(sex) + nsaid +
                as.factor(retire) + opiate + as.factor(severe2), data = indy.regs)

int.reg = lm(ints ~ as.factor(Race) + age + as.factor(inccat) + bmi + treat + as.factor(sex) + nsaid +
                   as.factor(retire) + opiate + as.factor(severe2), data = indy.regs)


sjt.lm(slope.reg, int.reg)

```

### e.) For each individual, compute the correlation between pain scores and average temperature on the dates the pain scores were taken and constuct a graph to display these correlations. Discuss whether pain is correlated with temperature.

```{r, message = FALSE, warning = FALSE}

weather = mcalindon %>%
  select(ID, WeatherDate, avgtemp)

pains = mcalindon %>%
  select(ID, pain.1, pain.2, pain.3, pain.4, pain.4, pain.5, pain.6, pain.7) %>%
  group_by(ID) %>%
  slice(1) 
  
pains = pains %>%
  gather(key = pain.time, value = pain.score, pain.1:pain.7 ) %>%
  group_by(ID) %>%
  mutate( index = row_number(ID))

days = mcalindon %>%
  select(ID, lastdt1, lastdt2, lastdt3, lastdt4, lastdt5, lastdt6, lastdt7) %>%
  group_by(ID) %>%
  slice(1)

days = days %>%
  gather(key = time.name, value = day, lastdt1:lastdt7) %>%
  mutate(index = row_number(ID))

pain.w.days = pains %>%
  inner_join(days)

pain.day.temp = pain.w.days %>%
  rename(WeatherDate = day) %>%
  inner_join(weather)

pain.day.temp = pain.day.temp %>%
  group_by(ID) %>%
  mutate(correlation = cor(pain.score, avgtemp, use = "complete.obs"))


only.cor = pain.day.temp %>%
  select(ID, correlation) %>%
  group_by(ID) %>%
  slice(1)

hist.cor = only.cor %>%
  ggplot(aes(x = correlation)) +
  geom_histogram(binwidth = .1) +
  geom_vline(aes(xintercept=mean(only.cor$correlation, na.rm = TRUE), color="mean"),
             linetype="dashed",
             size=1) +
  xlab("Correlation") +
  ylab("Count") +
  ggtitle("Histogram: Correlation values between Pain and Avg. Temperature") +
  theme_minimal() +
  scale_color_manual( labels = c(paste("Mean = ", round(mean(only.cor$correlation, na.rm = TRUE), digits = 3))), 
                      name = "Legend: ", values = c(mean = "red")) +
  theme(legend.position = "right") +
  labs(caption = "Note: individuals with only one observation are excluded (cannot calculate correlation)")


hist.cor

```

# Problem 2

### In the paper by Wang et al. (paper #10 in your syllabus), reproduce Table 2 using just the outcome data without trying to fit the mixed model. In other words, the differences at each time in the two treatment groups should be calculated just as a difference in means with a corresponding confidence interval. It is easist if you fit a simple linear model to produce the effects at each time for each difference compared to baseline. You can then also find the difference of the differences to compare treated and control.  

```{r}

wang <- read_csv("Wang.csv")

### need to put in long format!

```